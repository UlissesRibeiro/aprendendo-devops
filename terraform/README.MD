# √çndice

- [Sobre](#sobre)
- [O que √© cloud](#o-que-√©-cloud)
- [Instala√ß√£o](#instala√ß√£o)
- [EC2, S3 e IAM](#ec2-s3-e-iam)
- [Como funciona a comunica√ß√£o com a cloud?](#como-funciona-a-comunica√ß√£o-com-a-cloud)
- [Instala√ß√£o](#instala√ß√£o)
- [Explicando o HCL](#explicando-o-hcl)
- [Iniciando o terraform](#iniciando-o-terraform)
- [Comandos b√°sicos](#comandos-b√°sicos)
- [Criando um instancia EC2](#criando-um-instancia-ec2)


## Sobre

O Terraform, √© uma ferramenta de infraestrutura como c√≥digo(Infraestructure as Code - IAC), desenvolvida pela HashiCorp.
A ideia √© que voc√™ descreva a infraestrutura desejada em um arquivo de configura√ß√£o escrito em formato HCL - HashiCorp Configuration Language, e a partir dai o Terraform cuida da implanta√ß√£o.
<br>
Com o Terraform √© possivel provisionar diversos recursos em diversos providers de nuvem, como :
- AWS
- Azure
- Google Cloud Platform

Al√©m de recursos on-premise(infraestrutura local).

## O que √© cloud

Segue um trecho retirado da Wikip√©dia :

<i>Computa√ß√£o em nuvem (em ingl√™s, cloud computing) √© um termo coloquial para a disponibilidade sob demanda de recursos do sistema de computador, especialmente armazenamento de dados e capacidade de computa√ß√£o, sem o gerenciamento ativo direto do utilizador. O termo geralmente √© usado para descrever centros de dados dispon√≠veis para muitos utilizadores pela Internet. Nuvens em grande escala, predominantes hoje em dia, geralmente t√™m fun√ß√µes distribu√≠das em v√°rios locais dos servidores centrais. Se a conex√£o com o utilizador for relativamente pr√≥xima, pode ser designado um servidor de borda.</i>
<br>
Ou seja, nada mais √© do que uma abstra√ß√£o de servi√ßos.

## EC2, S3 e IAM

<b>√â necess√°rio que voc√™ tenha uma conta gratuita mesmo na AWS!</b>
<br>

Antes de irmos diretamente ao terraform, precisamos conhecer esses servi√ßos que v√£o ser de uso agora nesse momento.

- EC2 : Na AWS EC2, s√£o as maquinas virtuais, VMs.
- S3 : Na AWS S3, √© o servi√ßo de storage/armazenamento.
- IAM : Na AWS IAM , √© um servi√ßo de gerenciamento/controle de acessos.

Nesse momento, voc√™ deve criar um S3 e o IAM, abaixo segue o passo-a-passo:

- S3 <a href="https://www.youtube.com/watch?v=e6w9LwZJFIA">Getting started with Amazon S3 - Demo</a>

- IAM <a href="https://www.youtube.com/watch?v=wRzzBb18qUw">How do I set up an IAM user and sign in to the AWS Management Console using IAM credentials?
</a>

## Como funciona a comunica√ß√£o com a cloud?

A comunica√ß√£o com a cloud √© feita atrav√©s de uma API, ent√£o quando estamos no console da AWS, clicando, estamos basicamente, enviando nossa requisi√ß√£o para a API e ela manda para cloud, sendo assim, o Terraform faz o mesmo papel da console da AWS. No curso esta sendo usado os servi√ßos da AWS, por ser a cloud mais utilizada, mas os conceitos apresentados aqui podem ser utilizados em qualquer outra cloud.

## Instala√ß√£o :

Podemos usar o terraform de varias maneiras, seja instalando na sua maquina ou com um container docker, ent√£o vou deixar aqui as duas formas :

### Instalando na maquina

    wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg

    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
    
    sudo apt update && sudo apt install terraform

### Docker

    docker run -dit -v /path:/path -w /path --entrypoint "" hashicorp/terraform:light sh

- Explicando o docker :
    - no path √© interessante voc√™ passar o seu path de estudos onde est√£o seus arquivos .tf que v√£o ser utilizados pelo terraform
    - o -w √© de workdir, para indicar que o container ao voc√™ acessar no bash, j√° ir para o diretorio de trabalho, no caso o path que voc√™ definiu
    - o --entrypoint, √© por que o container do terraform j√° vai querer iniciar executando o bin√°rio, ent√£o para ele n√£o iniciar passamos o entrypoint vazio

## Explicando o HCL

O arquivo HCL, √© como um .yml melhorado digamos assim, e se assemelha ao Vagrantfile saca? Ent√£o vamos pegar a informa√ß√£o com base na documenta√ß√£o oficial <a href="https://developer.hashicorp.com/terraform/language/syntax/configuration">aqui</a>.
<br>
basicamente ele √© composto por :
- Blocks
- Arguments
- Identifiers
<hr>



    provider "aws" {
      region  = "us-east-1"
      version = "~> 2.0"
    }

    terraform {
      backend "s3" {
        # Lembre de trocar o bucket para o seu, n√£o pode ser o mesmo nome
        bucket = "nome-do-seu-bucket"
        key    = "terraform-test.tfstate"
        region = "us-east-1"
      }
    }

## Iniciando o terraform
Para iniciar o diret√≥rio do terraform, semelhante ao git,vagrant, etc, usamos o comando <b>terraform init</b>, isso vai fazer com que seja criada um diret√≥rio <b>.terraform</b>, a partir de agora poderemos usar os demais comandos do terraform... opa, deu erro ai ne? Lembra que falei pra criar(assistir ao video de como criar) o IAM, pois bem, o erro √© exatamente referente a falta de credenciais de acesso, para contornar isso use vari√°veis de ambiente :

- export AWS_ACCESS_KEY_ID=a-id-gerada-no-iam
- export AWS_SECRET_ACCESS_KEY=a-chave-secreta-gerada

Rode novamente o terraform init

## Comandos b√°sicos

Aqui veremos os comandos mais utilizados no dia-a-dia!

- init : para iniciarmos um diret√≥rio
- plan : ele serve para fazer um "check" do seu arquivo HCL com o state e o que j√° tem criado na infra/cloud
- apply : ele vai criar de fato o que foi definido no HCL, se for para criar uma EC2, ser√° ent√£o criada nesse comando.
- destroy : como o nome diz, vai destruir o que foi criado com base no HCL.

√â importante lembrar de que ao rodar o plan, execute junto do par√¢metro -out:path :

    terraform plan -out ec2

e quando for dar o apply usar:
    
    terraform apply ec2

## Criando um instancia EC2

Para criar nossa instancia EC2 a partir do terraform, segue abaixo o nosso c√≥digo base:

    resource "aws_instance" "web_lab" {
      ami           = "ami-053b0d53c279acc90"
      instance_type = "t2.micro"
      
      tags = {
        Name = "webserver_lab"
      }
    }

o recurso(resource) utilizado para provisionar EC2 na AWS, √© o "aws_instance", e dentro do bloco passamos a ami da imagem referente a region onde voc√™ quer criar, essa √© referente a us-east-1, dessa forma vamos criar uma instancia EC2 padr√£o free.
<br>
Agora quando voc√™ rodar : terraform plan -out ec2 , o terraform vai identificar que ser√° criada uma instancia, bastando ent√£o voc√™ aplicar e aguardar a cria√ß√£o!

- Quando criamos uma instancia dessa forma, ela n√£o vai ter um par de chaves para acesso SSH, ent√£o voc√™ pode fazer da seguinte maneira, crie um par de chaves usando : ssh-keygen,e dentro do seu arquivo .tf passe o seguinte bloco :

   
      resource "aws_key_pair" "deployer" {
        key_name   = "sua_chave.pub"
        public_key = file("/root/.ssh/sua_chave.pub")
      }
e dentro do bloco da instancia, coloque: 

    key_name = aws_key_pair.deployer.key_name

## Organizando seu ambiente

- A partir de agora vamos trabalhar de forma mais organizada, para criarmos uma boa pratica na cria√ßao das nossas instancias EC2 usando o Terraform.

- Nosso ambiente de trabalho ser√° agora da seguinte forma :

üìÅ app_webserver
  - <img src=images/tf.ico width=15px> main.tf

üìÅ modules
  - <img src=images/tf.ico width=15px> security_groups.tf

üìÅ keys_aws
  - <img src=images/sshkey.png width=15px> security_groups.tf